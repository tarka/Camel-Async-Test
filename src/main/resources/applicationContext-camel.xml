<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:camel="http://camel.apache.org/schema/spring"
       xsi:schemaLocation="
             http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
             http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd">

    <bean id="amq" class="org.apache.camel.component.jms.JmsComponent">
        <property name="connectionFactory" ref="amqConnectionFactory"/>
    </bean>

    <camel:endpoint id="inputq" uri="amq:inputq"/>
    <camel:endpoint id="expiredMessages" uri="amq:expiredMessages"/>

    <bean id="messageLogger" class="com.atlassian.camelapp.FailingMessageLogger"/>
    <bean id="expiredMessageLogger" class="com.atlassian.camelapp.ExpiredMessageLogger"/>

    <bean id="retryTagger" class="com.atlassian.camelapp.MessageRetryTagger"/>


    <camelContext id="camel" trace="false" xmlns="http://camel.apache.org/schema/spring" >

        <errorHandler id="defaultErrorHandler" type="DefaultErrorHandler" deadLetterUri="amq:expiredMessages" >
            <redeliveryPolicy maximumRedeliveries="0" logStackTrace="false" logHandled="true" />
        </errorHandler>

        <route id="inputroute">

            <from ref="inputq"/>
            <bean ref="messageLogger"/>

            <onException>
                <exception>com.atlassian.camelapp.PermanentFailureException</exception>
                <redeliveryPolicy maximumRedeliveries="0"/>
                <handled><constant>true</constant></handled>
                <log loggingLevel="WARN" message="Message had permanent failure, sending to expired queue"/>
                <removeHeader headerName="AMQ_SCHEDULED_DELAY"/>
                <to ref="expiredMessages"/>
            </onException>

            <onException >
                <exception>com.atlassian.camelapp.TemporaryFailureException</exception>
                <redeliveryPolicy maximumRedeliveries="0"/>
                <handled><constant>true</constant></handled>
                <bean ref="retryTagger"/>
                <choice>
                    <when>
                        <simple>${header.com.atlassian.hams.attempts} >= 5</simple>
                        <log loggingLevel="WARN" message="Message exceeded retries, sending to expired queue"/>
                        <removeHeader headerName="AMQ_SCHEDULED_DELAY"/>
                        <to ref="expiredMessages"/>
                    </when>
                    <otherwise>
                        <setHeader headerName="AMQ_SCHEDULED_DELAY"><constant>5000</constant></setHeader>
                        <to ref="inputq"/>
                    </otherwise>
                </choice>

            </onException>

        </route>

        <route id="expiredRoute">
            <from ref="expiredMessages"/>
            <bean ref="expiredMessageLogger"/>
        </route>

    </camelContext>


</beans>